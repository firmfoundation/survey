<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Survey Owel - version 1.0.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <style>
        body {
          margin: 0;
          font-family: "Lato", sans-serif;
        }

        .navbar {
           border-bottom: 1px solid #ced4da;
           margin-bottom: 8px;
           box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
        }

        .sidebar {
          margin: 0;
          padding: 0;
          width: 165px;
          background-color: #f1f1f1;
          position: fixed;
          height: 100%;
          overflow: auto;
        }

        .sidebar a {
          display: block;
          color: black;
          padding: 16px;
          text-decoration: none;
          box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
        }
        
        .sidebar a.active {
          background-color: #555;
          color: white;
        }

        .sidebar a:hover:not(.active) {
          background-color: #f1f1f1;
          color: white;
        }

        div.content {
          margin-left: 160px;
          padding: 1px 16px;
          height: 1000px;
        }

        @media screen and (max-width: 700px) {
          .sidebar {
            width: 100%;
            height: auto;
            position: relative;
          }
          .sidebar a {float: left;}
          div.content {margin-left: 0;}
        }

        @media screen and (max-width: 400px) {
          .sidebar a {
            text-align: center;
            float: none;
          }
        }
        .cs-1 {
            background: #219ebc;
            padding:14px;
            margin-top: 5px;
            margin-bottom: 10px;
            overflow: scroll;
            max-height: 30rem;
            box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
        }
       .cs-2 {
            background: #fb8500;
            padding:14px;
            margin-top: 5px;
            margin-bottom: 10px;
            overflow: scroll;
            box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
        }
        .div-modal {
            overflow: scroll;
            width:77%;
            height:70%;
            position: fixed;
            background-color: #e9ecef;
            top: 5%;
            left: 15%;
            margin-top: 0px;
            margin-left: 0px;
            padding: 5px;
            border-color: #e9ecef;
            border-width: 1px;
            border-style: solid;
            box-shadow: rgba(0, 0, 0, 0.25) 0px 54px 55px, rgba(0, 0, 0, 0.12) 0px -12px 30px, rgba(0, 0, 0, 0.12) 0px 4px 6px, rgba(0, 0, 0, 0.17) 0px 12px 13px, rgba(0, 0, 0, 0.09) 0px -3px 5px;
        }
        .modal-cs-1 {
            background: #e9ecef;
            padding:4px;
            margin-left: 8px;
            border-radius: 5px;
            max-width: 38rem;
            
        }
        .modal-cs-2 {
            background: #e9ecef;
            padding: 4px;
            margin-left: 8px;
            border-radius: 5px;
            max-width: 38rem;
        }
        .modal-bottom {
            max-width: 73rem;
        }
        .modal-close {
            margin: 1px;
            padding: 1px;
        }
   </style>
</head>
<body>
      <nav class="navbar bg-body-tertiary">
          <div class="container">
              <img src="/static/img/survey-owel.png" alt="survey owel" width="60" class="rounded">
              Survey Owel - v1.0.0
          </div>
      </nav>

    <div class="sidebar">
      <a onClick="menuSurvey()">Survey</a>
      <a onClick="menuIndicator()">Indicators</a>
      <a onClick="menuQuestion()">Questions</a>
      <a href="#about">Users</a>
      <a href="#about">Survey Journal</a>
    </div>

    <div class="content">
        <div class="container-sm ">
            <div id="left-col" class="cs-1"></div>
        </div>
        <div class="container-sm ">
            <div id="right-col" class="cs-2"></div>
        </div>
    </div>

    <div id="modal-board"></div>

    <!-- Footer -->
    <footer class="fixed-bottom">
        <!-- Copyright -->
        <div class="text-center pt-2" style="background-color: rgba(0, 0, 0, 0.05); height: 50px;">
            Survey Owel - version 1.0.0  
            <img src="/static/img/survey-owel.png" alt="Survey Owel" width="40" class="rounded">
        </div>
        <!-- Copyright -->
    </footer>
    <!-- Footer -->
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="/static/js/survey.js"></script>
    <script src="/static/js/indicator.js"></script>
    <script src="/static/js/question.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
        <script>

            var questions;

            $(function () {
               
                $( document ).ready(function() {
                    createModal()
                    $('.div-modal').hide()
                    $.ajax({
                        url: '/surveys',
                        type: 'GET',
                        contentType: 'application/json',
                        success: function (response) {
                            var json = JSON.parse(response);
                            renderSurveys(json)
                        },
                        error: function (response) {
                            //console.log(response)
                        }
                    })
                });
               
                $('#btn-send').click(function () {  
                   var a = [];
                    for(var i = 0; i < questions.length; i++) {
                      var value = $(`input[name=${questions[i].ID}]:checked`).val();
                      a.push({
                         "question_id": questions[i].ID,
                         "answer": Number(value)
                      });
                    }
                     var payload = {
                        survey_id: "eff29c58-a270-4feb-b2da-c475e9562940",
                        user_id: "fda4697e-c5c4-455e-b462-4479f4169f6f",
                        result: a
                    };

                    $.ajax({
                        url: '/survey/results',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(payload),
                        success: function (response) {
                           alert("Thank you, survey received!")
                        },
                        error: function (response) {
                            //console.log(response)
                            
                           
                        }
                    })
                });
               

            })

            function getSurveyUsers(uid) {
                $.ajax({
                  url: `/surveys/users?survey_id=${uid}`,
                  type: 'GET',
                  contentType: 'application/json',
                  success: function (response) {
                      var json = JSON.parse(response);
                      renderSurveyJournal(json)
                  },
                  error: function (response) {
                      //console.log(response)
                  }
                })             
            }

            function getUserSurveyIndicators(survey_id, user_id) {
                $.ajax({
                  url: `/surveys/users/indicators?survey_id=${survey_id}&user_id=${user_id}`,
                  type: 'GET',
                  contentType: 'application/json',
                  success: function (response) {
                      var json = JSON.parse(response);
                      renderUserSurveyIndicators(json)
                      getUserRadarChart(survey_id, user_id)
                      getUserSurveyIndicatorsQuestions(survey_id, user_id)
                      //getUser(user_id)
                  },
                  error: function (response) {
                      //console.log(response)
                  }
                })             
            }

            function getUserSurveyIndicatorsQuestions(survey_id, user_id) {
                $.ajax({
                  url: `/surveys/users/indicators/questions?survey_id=${survey_id}&user_id=${user_id}`,
                  type: 'GET',
                  contentType: 'application/json',
                  success: function (response) {
                     var json = JSON.parse(response);
                    renderSurveyQuestions(json)
                  },
                  error: function (response) {
                      //console.log(response)
                  }
                })             
            } 

            function renderSurveys(s) {
                var tbody = document.createElement('tbody');
                $.each(s, function( key, v ) {
                   let survey_id = v.ID
                   let date = new Date(v.CreatedAt);
                   var d = date.toLocaleDateString('en-us', {day:"numeric", weekday:"long", year:"numeric", month:"short"}) // "Jul 2021 Friday"
                   $(tbody).append(
                        `<tr id="row-${v.ID}" onClick=getSurveyUsers("${survey_id}")>
                          <td>${v.name}</td>
                          <td>${v.ID}</td>
                          <td>${d}</td>
                        </tr>`
                   )
                });

                var table = document.createElement('table');
                $(table).addClass('table table-sm table-hover')
                $(table).append(
                      `<thead>
                        <tr>
                          <th scope="col">Survey title</th>
                          <th scope="col">UID</th>
                          <th scope="col">Created</th>
                        </tr>
                      </thead>`
                );
                $(table).append(tbody)

                var card = document.createElement('card');
                $(card).addClass('card')

                var cardBody = document.createElement('div')
                $(cardBody).addClass('card-body')
                $(cardBody).append(
                  `
                   <h5 class="card-title">Survey</h5>
                   <h6 class="card-subtitle mb-2 text-muted">List of surveys</h6>
                  `
                )
                $(card).append(cardBody)
                $(card).append(table)
               
               $("#left-col").append(card)

            }

            function renderSurveyJournal(s) {
                var tbody = document.createElement('tbody');
                $.each(s, function( key, v ) {
                   let survey_id = v.survey_id
                   let user_id = v.user_id
                   let tw = v.total_weight
                   let ti = v.total_indicator
                   let p = (100 * ti) / tw
                   p = Math.ceil(p)
                   $(tbody).append(
                        `<tr>
                          <td>${v.full_name}</td>
                          <td>${v.email}</td>
                          <td>${v.total_weight}</td>
                          <td>${v.total_indicator}</td>
                          <td>
                            <div class="progress">
                              <div class="progress-bar" role="progressbar" aria-label="Basic example" style="width: ${p}%" aria-valuenow="${p}" aria-valuemin="0" aria-valuemax="100">${p}%</div>
                            </div>
                          <td>
                          <td>
                            <button type="button" id="b-sj-${key}" onClick='getUserSurveyIndicators("${survey_id}", "${user_id}")'; class="btn btn-warning" style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .65rem;">
                              view survey
                            </button>
                          </td>
                        </tr>`
                   )
                });

                var table = document.createElement('table');
                $(table).addClass('table table-hover')
                $(table).append(
                      `<thead>
                        <tr>
                          <th scope="col">Full Name</th>
                          <th scope="col">Email</th>
                          <th scope="col">Weight</th>
                          <th scope="col">Result</th>
                          <th scope="col">evaluation</th>
                          <th scope="col"></th>
                        </tr>
                      </thead>`
                );
                $(table).append(tbody)

                var card = document.createElement('card');
                $(card).addClass('card')

                var cardBody = document.createElement('div')
                $(cardBody).addClass('card-body')
                $(cardBody).append(
                  `
                   <h5 class="card-title">Survey title : ${s[0].survey_name}</h5>
                   <h6 class="card-subtitle mb-2 text-muted">UID : ${s[0].survey_id}</h6>
                  `
                )
                $(card).append(cardBody)
                $(card).append(table)
                $("#right-col").empty();
                $("#right-col").append(card)

            }            

            function renderUserSurveyIndicators(s) {
                var tbody = document.createElement('tbody');
                $.each(s, function( key, v ) {
                   
                   let tw = v.total_weight
                   let ti = v.total_indicator
                   let p = (100 * ti) / tw
                   p = Math.ceil(p)
                   $(tbody).append(
                        `<tr>
                          <td>${v.indicator}</td>
                          <td>${v.total_weight}</td>
                          <td>${v.total_indicator}</td>
                          <td>
                            <div class="progress">
                              <div class="progress-bar" role="progressbar" aria-label="Basic example" style="width: ${p}%" aria-valuenow="${p}" aria-valuemin="0" aria-valuemax="100">${p}%</div>
                            </div>
                          <td>
                        </tr>`
                   )
                });

                var container = document.createElement('div');
                $(container).addClass('container')

                var table = document.createElement('table');
                $(table).addClass('table table-hover')
                $(table).append(
                      `<thead>
                        <tr>
                          <th scope="col">Indictor</th>
                          <th scope="col">Weight</th>
                          <th scope="col">Result</th>
                          <th scope="col">evaluation</th>
                        </tr>
                      </thead>`
                );
                $(table).append(tbody)

                var card = document.createElement('card');
                $(card).addClass('card')

                var cardBody = document.createElement('div')
                $(cardBody).addClass('card-body')
                $(cardBody).append(
                  `
                   <h6 class="card-subtitle mb-2 text-muted">selected user indicators</h6>
                  `
                )
                $(card).append(cardBody)
                $(card).append(table) 
                $(container).append(card)
                
                createModal()
                $("#modal-left-col").append(card)
                $('.div-modal').show()

            }    

            function getUserRadarChart(survey_id, user_id) {
                $.ajax({
                  url: `/surveys/users/indicators/radar-chart?survey_id=${survey_id}&user_id=${user_id}`,
                  type: 'GET',
                  contentType: 'application/json',
                  success: function (response) {
                       $('#radar-chart-preview').attr('src', `${response}`);
                  },
                  error: function (response) {
                      //console.log(response)
                  }
                })             
            } 

            function renderSurveyQuestions(s) {
                var tbody = document.createElement('tbody');
                $.each(s, function( key, v ) {
                   
                   let tw = v.total_weight
                   let ti = v.total_indicator
                   let p = (100 * ti) / tw
                   p = Math.ceil(p)
                   $(tbody).append(
                        `<tr>
                          <td>${v.question}</td>
                          <td>${v.total_weight}</td>
                          <td>${v.total_indicator}</td>
                          <td>
                            <div class="progress">
                              <div class="progress-bar" role="progressbar" aria-label="Basic example" style="width: ${p}%" aria-valuenow="${p}" aria-valuemin="0" aria-valuemax="100">${p}%</div>
                            </div>
                          <td>
                        </tr>`
                   )
                });

                var table = document.createElement('table');
                $(table).addClass('table table-hover')
                $(table).append(
                      `<thead>
                        <tr>
                          <th scope="col">Question</th>
                          <th scope="col">Weight</th>
                          <th scope="col">Result</th>
                          <th scope="col">evaluation</th>
                        </tr>
                      </thead>`
                );
                $(table).append(tbody)

                var card = document.createElement('card');
                $(card).addClass('card')

                var cardBody = document.createElement('div')
                $(cardBody).addClass('card-body')
                $(cardBody).append(
                  `
                   <h6 class="card-subtitle mb-2 text-muted">Questions presented to user.</h6>
                  `
                )
                $(card).append(cardBody)
                $(card).append(table) 
               
                
                //createModal()
                $(".modal-bottom").append(card)
                $('.div-modal').show()
                
            }

            function createModal() {
              $('.div-modal').remove()
              $("#modal-board").append(
                `<div class="div-modal">
                    <div class="text-end modal-close">
                      <button type="button" onClick="closeModal()" class="btn-close" aria-label="Close"></button>
                    </div>

                    <div class="container-sm ">
                        <div class="row">
                              <div class="col modal-cs-1">
                                <!-- left  -->
                                <div id="modal-left-col"></div>
                              </div>

                              <div class="col modal-cs-2">
                                <!-- right  -->
                                  <img src="" id="radar-chart-preview" alt="radar chart" width="550" class="rounded">
                              </div>
                        </div>
                        <div class="row">
                            <!-- lower -->
                            <div class="modal-bottom"></div>
                        </div>
                    </div>    
                </div>`)
            }  

            function closeModal() {
                $('.div-modal').remove()
            }               
        </script>
</body>
</html>
